---
- name: Configure journald
  hosts: all
  become: yes
  tasks:
    - name: "Minimize logging"
      ansible.builtin.lineinfile:
        dest: "/etc/systemd/journald.conf"
        regexp: "^.*{{ item.key }}="
        line: "{{ item.key }}={{ item.value }}"
      loop:
        - key: Storage
          value: volatile
        - key: MaxRetentionSec
          value: "8h"

- name: Install TimescaleDB
  hosts: all
  become: yes
  tasks:
    - include_tasks: ./tasks/timescaledb.yml

- name: Install Promscale
  hosts: all
  become: yes
  tasks:
    - include_tasks: ./tasks/promscale.yml

- name: Set up pgBackRest
  hosts: all
  become: yes
  tasks:
    - include_tasks: ./tasks/pgbackrest.yml

- name: Set up node_exporter
  hosts: all
  become: yes
  pre_tasks:
    - name: node_exporter | Create cert dir
      file:
        path: "/etc/node_exporter"
        state: directory
        owner: root
        group: root

    - name: node_exporter | Create private key
      community.crypto.openssl_privatekey:
        path: /etc/node_exporter/tls.key

    - name: node_exporter | Create CSR
      community.crypto.openssl_csr_pipe:
        privatekey_path: /etc/node_exporter/tls.key
        common_name: "localhost"
      register: node_exporter_csr

    - name: node_exporter | Create cert and key
      openssl_certificate:
        path: /etc/node_exporter/tls.cert
        csr_content: "{{ node_exporter_csr.csr }}"
        privatekey_path: /etc/node_exporter/tls.key
        provider: selfsigned
  post_tasks:
    - name: node_exporter | Change ownership of directory
      file:
        dest: "/etc/node_exporter"
        owner: node-exp
        recurse: yes
        state: directory
  roles:
    - cloudalchemy.node_exporter
  vars:
    node_exporter_tls_server_config:
      cert_file: /etc/node_exporter/tls.cert
      key_file: /etc/node_exporter/tls.key
    # node_exporter_basic_auth_users:
    #   randomuser: examplepassword

- name: Install postgres_exporter
  hosts: all
  become: yes
  tasks:
    - include_tasks: ./tasks/postgres_exporter.yml

- name: Install rsyslog
  hosts: all
  become: yes
  # The role has support for a remote receiver, but it doesnâ€™t quite
  # match what Promtail needs.
  post_tasks:
    - name: rsyslog | Add forwarding rule
      copy:
        # Queuing based on <https://utcc.utoronto.ca/~cks/space/blog/sysadmin/PromtailRsyslogForwarderSetup>.
        content: 'action(type="omfwd" target="127.0.0.1" protocol="tcp" port="1514" Template="RSYSLOG_SyslogProtocol23Format" TCP_Framing="octet-counted" KeepAlive="on" action.resumeRetryCount="-1" queue.type="linkedlist" queue.size="50000")'
        dest: "/etc/rsyslog.d/promtail.conf"
        mode: "0644"
        owner: "root"
        group: "root"
        validate: "rsyslogd -N1 -f %s"
  roles:
    - robertdebock.rsyslog
  vars:
    rsyslog_config_file_format: advanced

- name: Install Promtail
  hosts: all
  become: yes
  tasks:
    - include_tasks: ./tasks/promtail.yml
